
# Правила написания тестов

## Классификация:

Для разработчиков тесты делятся на следующие типы:

- **end-to-end (e2e)** - от вызова контроллера, до возврата ответа, со всеми внешними вызовами и обращениями в базу данных. Нужны для проверки общей работоспособности бизнес-сценария
- **интеграционные тесты** - тесты с поднятием Spring контекста, которые проверяют взаимодействие нескольких классов между собой, но не всего бизнес-сценария целиком. Например проверка валидации в контроллере, проверка корректности выполняемых SQL запросов в бд, проверка работоспособности вызовов внешних сервисов
- **юнит** - тесты отдельных классов, с мокированием всех зависимостей, нужды для точечной проверки каждого из возможных вариантов вызова методов

## Соотношение количества тестов:

Соотношение количества тестов в зависимости от их типа:

- end-to-end - минимальное количество, выполняются медленнее всего
- интеграционные тесты - среднее количество, выполняются быстрее e2e
- юнит - максимальное количество, выполняются быстрее всего

## Общие правила:

- один тест - один вызов проверяемого метода (или бизнес сценария)
- необходимо проверять как позитивные, так и негативные сценарии работы методов
- тесты должны выполняться быстро - несколько секунд на полный прогон, чтобы разработчик мог их запускать как можно чаще
- тесты следует писать по структуре AAA (Arrange-Act-Assert)
- тесты должны легко читаться
- комментарии к тестам, а также изменение отображаемого имени через @DisplayName являются опциональными. В случае тестирования сложных бизнес-сценариев писать комментарии настоятельно рекомендуется
- тесты должны быть изолированы друг от друга, работать вне зависимости от порядка их запуска, и очищать за собой любое измененное ими общее состояние (бд, кеши)
- в идеале любое изменение в коде должно приводить к падению тестов
- в тестах надо избегать использования констант из основного кода проекта
- в CI/CD тесты должны запускаться при создании Merge Request, при коммитах в Merge Request, при создании tag'ов, а также перед каждой сборкой для отправки кода в артифактори
- в тестах необходимо избегать Thread.sleep() и подобных конструкций
- для проверки внутренней логики сервисов с помощью unit тестов, методы можно помечать как protected (вместо private) и размещать класс тестов в той же структуре пакетов, что и проверяемый класс, тогда protected методы будут доступны для вызова
- если для проверки структуры http запросов/ответов вы используете json файлы, то они должны быть изолированы друг от друга в ресурсах и храниться в той же структуре пакетов, что и контроллеры, например: /test/resources/mock/controller/admins/roles (эндпоинт /roles в контроллере AdminsController)

## Покрытие:

- все публичные методы классов должны быть покрыты тестами
- покрытие кода должно составлять не менее 70%
- покрытие высчитывается с помощью jacoco плагина по линиям кода
- разрешается исключить из покрытия пакеты exception, config, dto и прочие вспомогательные пакеты, которые не тестируются напрямую

## Нейминг:

- в рамках одного микросервиса должны соблюдаться единые правила наименования 
- рекомендуемый нейминг **when_имяМетода_условияТеста_then_ожидаемыйРеузльтат**, примеры:
    - when_searchUser_then_success
    - when_searchUser_withNonExistingId_then_userNotFoundException
- имена классов тестов должны заканчиваться на **Test**
- имена классов юнит-тестов рекомендуется заканчивать на **UnitTest**

## Тесты с поднятием Spring контекста:

Создается общий родительский класс AbstractTest, который помечается аннотацией SpringBootTest и в него выполняются все инъекции бинов, а также mock и spy бинов

Все остальные классы тестов, использующие Spring - наследуются от AbstractTest

В наследниках AbstractTest не должно выполняться инъекций bean'ов, иначе будет загрязняться контекст, что приведёт к значительному замедлению работы тестов

Пример класса AbstractTest:

|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `@SpringBootTest``(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)`<br>`@AutoConfigureMockMvc`<br>`@ActiveProfiles``(``"test"``)`<br>`public` `abstract` `class` `AbstractTest {`<br><br>    `@Autowired`<br>    `protected` `MockMvc mockMvc;`<br><br>    `@Autowired`<br>    `protected` `UserService userService;`<br><br>    `@Mock`<br>    `protected` `UserApiClient userApiClient;`<br><br>    `@SpyBean`<br>    `protected` `AdminsRepoistory adminsRepoistory;`<br><br>`}` |



## Тесты с участием внешних интеграций по http:

Для внешних интеграций должны быть написаны заглушки с использованием wiremock

Настройка wiremock

Подключаем зависимость:

|                                                                                                                                                                                                                                                                                                  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `dependencyManagement {`<br><br>  `imports {`<br>    `mavenBom` `"org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"`<br>  `}`<br><br>`}`<br><br>`dependencies {`<br>    `implementation` `'org.springframework.cloud:spring-cloud-starter-contract-stub-runner'`<br>`}` |

Создаем класс AbstractWireMockTest, который будет инкапсулировать работу wiremock, и он будет отнаследован от AbstractTest:

|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `@ExtendWith``(WireMockExtension.``class``)`<br>`public` `class` `AbstractWireMockTest` `extends` `AbstractTest {`<br><br>    `public` `static` `final` `String SEARCH_USERS_MIDPOINT_URL =` `"/midpoint/ws/rest/users/search"``;`<br><br>    `protected` `static` `WireMockServer wireMockServer;`<br><br>    `static` `{`<br>        `wireMockServer =` `new` `WireMockServer(wireMockConfig().dynamicPort());`<br>        `wireMockServer.start();`<br>        `System.setProperty(``"wiremock.server.port"``, String.valueOf(wireMockServer.port()));`<br>    `}`<br><br>    `@AfterEach`<br>    `void` `resetWireMock() {`<br>        `wireMockServer.resetAll();`<br>    `}`<br><br>    `@SneakyThrows`<br>    `protected` `void` `stubResponseWithRequestBody(String url, HttpMethod method, String jsonRequest, String jsonResponse) {`<br>        `wireMockServer.stubFor(request(method.name(), urlMatching(url))`<br>                `.withRequestBody(equalToJson(jsonRequest))`<br>                `.willReturn(aResponse()`<br>                        `.withHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)`<br>                        `.withBody(jsonResponse)));`<br>    `}`<br>`}` |

Прописываем в application-test.yaml хост и порт wiremock для внешней интеграции:

|                                                                     |
| ------------------------------------------------------------------- |
| `midpoint:`<br>  `host: http:``//localhost:${wiremock.server.port}` |

Пример теста с использованием wiremock:

|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `class` `AdminControllerTest` `extends` `AbstractWireMockTest {`<br><br>    `public` `static` `final` `String TEST_LOGIN =` `"ruatest"``;`<br><br>    `@Test`<br>    `void` `when_adminsRoles_then_success()` `throws` `Exception {`<br>        `String userOid =` `"3e360e5e-f115-4785-a887-b7d7dfc4eed1"``;`<br><br>        `stubSearchUsersResponse();`<br><br>        `stubSearchRolesResponse(userOid);`<br><br>        `mockMvc.perform(get(``"/admins/roles"``)`<br>                        `.header(HttpHeaders.AUTHORIZATION, TOKEN_WITH_LOGIN)`<br>                        `.queryParam(``"category"``,` `"Роль"``)`<br>                        `.queryParam(``"relation"``,` `"Владелец"``)`<br>                        `.queryParam(``"nameDescriptionPart"``,` `"Часть имени или описания"``)`<br>                `)`<br>                `.andExpect(status().isOk())`<br>                `.andExpect(jsonPath(``"$.id"``).isNotEmpty())`<br>                `.andExpect(jsonPath(``"$.timestamp"``).isNotEmpty())`<br>                `.andExpect(jsonPath(``"$.data.itemsCount"``).value(``1``))`<br>                `.andExpect(jsonPath(``"$.data.items.length()"``).value(``1``))`<br>                `.andExpect(jsonPath(``"$.data.items[0].oid"``).value(``"e28ca385-d24a-482b-b5aa-5357b87dfc06"``))`<br>                `.andExpect(jsonPath(``"$.data.items[0].name"``).value(``"TEST_role"``))`<br>                `.andExpect(jsonPath(``"$.data.items[0].description"``).value(``"согласование договоров с контрагентами-нерезидентами отделом учета хоз.операций"``))`<br>                `.andExpect(jsonPath(``"$.data.items[0].category"``).value(``"Доступ к рассылке"``))`<br>                `.andExpect(jsonPath(``"$.data.items[0].relation"``).value(``"Владелец"``));`<br><br>    `}`<br><br>    `private` `void` `stubSearchUsersResponse() {`<br>        `String studSearchUsersResponse = TestFileUtil.readFileFromResources(``"mock/response/admins/roles/search-user-response.json"``);`<br>        `String midpointSearchUsersRequest =` `""``"`<br>                `{`<br>                    `"query"``: {`<br>                        `"filter"``: {`<br>                            `"text"``:` `"extension/login = '%s'"`<br>                        `},`<br>                        `"paging"``: {`<br>                            `"orderBy"``:` `"name"``,`<br>                            `"offset"``:` `0``,`<br>                            `"maxSize"``:` `15`<br>                        `}`<br>                    `}`<br>                `}`<br>                `""``".formatted(TEST_LOGIN);`<br><br>        `stubResponseWithRequestBody(SEARCH_USERS_MIDPOINT_URL, HttpMethod.POST, midpointSearchUsersRequest, studSearchUsersResponse);`<br>    `}`<br><br>    `private` `void` `stubSearchRolesResponse(String userOid) {`<br>        `String studSearchRolesResponse = TestFileUtil.readFileFromResources(``"mock/response/admins/roles/search-roles-response.json"``);`<br><br>        `String midpointSearchRolesRequest =` `""``"`<br>                `{`<br>                    `"query"``: {`<br>                        `"filter"``: {`<br>                            `"text"``:` `"(extension/ownerRef matches (oid='%s')) and (name contains[origIgnoreCase] 'Часть имени или описания' or extension/roleDescription contains[origIgnoreCase] 'Часть имени или описания') and extension/roleCategory = 'Application role'"`<br>                        `},`<br>                        `"paging"``: {`<br>                            `"orderBy"``:` `"name"``,`<br>                            `"offset"``:` `0``,`<br>                            `"maxSize"``:` `15`<br>                        `}`<br>                    `}`<br>                `}`<br>                `""``".formatted(userOid);`<br><br>        `stubResponseWithRequestBody(SEARCH_ROLES_MIDPOINT_URL, HttpMethod.POST, midpointSearchRolesRequest, studSearchRolesResponse);`<br>    `}`<br>`}` |

В данном примере выполняется stub для двух внешних запросов с помощью



**Важно!** Для каждой внешней интеграции должен быть написан ряд типовых тестов:

- таймаут ответа
- ответ со статусом 400
- ответ со статусом 500

## Тесты с использованием баз данных:

Все тесты с использованием базы данных должны быть изолированы друг от друга, для этого:

- каждый тест наполняет бд своими данными с помощью @Sql аннотации и отдельных скриптов
- скрипты должны лежать в такой же структуре папок, что и класс теста, чтобы для каждого теста (или класса тестов), набор скриптов был изолирован от других: /test/resources/sql/controller/admins/roles (для эндпоинта /roles в контроллере AdminsController)
- каждый тест помечается аннотацией @Transactional если он выполняется в одном потоке, чтобы откатывать любые изменения, внесенные в бд с помощью скрипта или бизнес-логики

Если в сервисе нет сложных или спецэффических для хранилища (например с jsonb синтаксисом) sql запросов, то разрешается использовать in-memory хранилище, например h2, что позволяет значительно ускорить выполнение тестов

В остальных случаях рекомендуется использовать testcontainers

Пример использования SQL аннотации TODO  
Пример настройки postgres testcontainer TODO

## Параметризированные тесты:

Для репетативных сценариев следует использовать парметризированные тесты



Пример реализации:


## Тесты с интеграциями по kafka:

TODO